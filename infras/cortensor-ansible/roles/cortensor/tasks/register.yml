---
- name: Prepare key indices per host
  set_fact:
    key_indices: "{{ hostvars[inventory_hostname]['key_pair_index'] | string | replace(' ', '') | split(',') }}"
  when: hostvars[inventory_hostname]['key_pair_index'] is defined

- name: Register cortensor for each instance
  shell: "{{ cortensor_bin }}/cortensord register --env {{ cortensor_home }}/.env-{{ item }}"
  args:
    executable: /bin/bash
  become_user: "{{ cortensor_user }}"
  loop: "{{ key_indices }}"
  when: key_indices is defined
  register: register_result
  ignore_errors: yes

- name: Verify cortensor instance
  shell: "{{ cortensor_bin }}/cortensord verify --env {{ cortensor_home }}/.env-{{ item }}"
  args:
    executable: /bin/bash
  become_user: "{{ cortensor_user }}"
  loop: "{{ key_indices }}"
  when: key_indices is defined
  register: verify_result
  ignore_errors: yes

- name: Display registration results
  debug:
    msg: |
      Node: {{ inventory_hostname }}
      Registration: {{ 'SUCCESS' if register_result is succeeded else 'FAILED' }}
      Verification: {{ 'SUCCESS' if verify_result is succeeded else 'FAILED' }}
